# useful comment
name: terratest

on:
  push:
    branches:
    - main
  pull_request:
    branches:
      - main

jobs:
  detect-and-test:
    runs-on: ubuntu-latest
    env:
      EXCLUDED_DIRS: ".github test" #space-delimited list for multiple exclusions

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Get base dir
      run: |
        base_dir=$(pwd)
        echo "base_dir=$base_dir" >> $GITHUB_ENV

    - name: Get changed dir
      id: changed-dir
      run: |
        changed_dirs=$(git diff --name-only origin/${{ github.event.repository.default_branch }} origin/${{ github.head_ref }} | xargs dirname | sort | uniq)
        for dir in $EXCLUDED_DIRS; do
          changed_dirs=$(echo "$changed_dirs" | grep -v "^$dir")
        done
        echo $changed_dirs
        echo "changed_dirs=$changed_dirs" >> $GITHUB_ENV
       
    - name: Run Terratest
      run: |
        cd ${{ env.base_dir }}/test/
        go mod download
        ls ${{ env.base_dir }}/test/
        for dir in ${{ env.changed_dirs }}; do
          cd ${{ env.base_dir }}
          ls -al
          cd $dir
          terraform init
          go test -v ${{ env.base_dir }}/test/...
        done

    # TODO: determine best way to pair success runs with commit hash, and store in dir that was ran against. Succeed workflow if recorded hash is before the one that was successful
    # - name: Upload Test Results
    #   if: failure()
    #   uses: actions/upload-artifact@v3
    #   with:
    #     name: test-results
    #     path: /path/to/test-results
